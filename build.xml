<!--
 $Id$

 Notes. On unix, root privileges are required to handle file permissions
        properly (as required by the nature of the installation).
        Consequently, since this script is intended for developers to use,
        and the source is expected to be in the user's home directory, 
        the Java VM's concept of the current user (user.home} cannot be used.
        Instead, the source is assumed to be relative to the build script's
        location. This uses the "basedir" attribute of the project tag,
        which is *NOT* set here so that it is possible to override the 
        ant default if needed. The ant default is  the parent directory
        of the build.xml (this file).
-->
<project name="cfs2" default="" basedir="">

  <!-- environment -->
  <property environment="env"/>

  <!-- overridable -->
  <property name="SITEHOME" value="/home"/>
  <property name="SITECODE" value="cfs"/>
  <property name="WEBUSER" value="apache"/>
  <property name="CFSGRP" value="cfs"/>
  <property name="GKHOST" value="jdbc:postgresql://127.0.0.1:5432/cfs2gk"/>
  <property name="GKUSER" value="gatekeeper"/>
  <property name="GKUSERPW" value=""/>

  <!-- computed properties -->
  <property name="SRC" value="${basedir}"/>
  <property name="SRC_BIN" value="${SRC}/bin"/>
  <property name="SRC_APP" value="${SRC}/production/webapps/cfs2"/>
  <property name="SRC_CLASSES" value="${SRC_APP}/WEB-INF/classes"/>
  <property name="SRC_LIB" value="${SRC_APP}/WEB-INF/lib"/>

  <!-- classpath as both object and a property -->
  <path id="cfs2.classpath">
    <pathelement path="${SRC_CLASSES}"/>
    <fileset dir="${env.TOMCAT_HOME}/lib">
      <include name="**/*.jar"/>
    </fileset>
    <fileset dir="${env.TOMCAT_HOME}/common/lib">
      <include name="**/*.jar"/>
    </fileset>
  </path>
  <property name="CLASSPATH" refid="cfs2.classpath" />

  <property name="DEST" value="${SITEHOME}/${SITECODE}"/>
  <property name="DEST_DOCROOT" value="${DEST}/html"/>
  <property name="DEST_BIN" value="${DEST}/bin"/>
  <property name="DEST_LOGS" value="${DEST}/logs"/>
  
  <property name="DBTYPE2" value="postgresql"/>
  <property name="DBTYPE" value="mssql"/>

  <target name="showuser" >
    <echo message="Username: ${USER}"/>
  </target>

  <target name="winuser" description="get real user" unless="USER">
    <property name="USER" value="${env.USERNAME}"/>
  </target>

  <target name="user" description="get real user" if="is.logname">
    <property name="USER" value="${env.LOGNAME}"/>
  </target>

  <target name="sudouser" description="get real user" if="is.sudoer">
    <property name="USER" value="${env.SUDO_USER}"/>
  </target>

  <target name="realuser" description="set props">
    <available file="/home/${env.SUDO_USER}/cfs2/build.xml" property="is.sudoer" />
    <available file="/home/${env.LOGNAME}/cfs2/build.xml" property="is.logname" />
  </target>

  <target name="init" depends="realuser,sudouser,user,winuser,showuser">
    <tstamp/>
    <tstamp ><format property="NOW" pattern="yyyy-MM-dd hh:mm:ss" /></tstamp>
    <tstamp ><format property="NOW2" pattern="yyyy-MMM-dd hh:mm:ss" /></tstamp>
    <tstamp ><format property="NOW3" pattern="yyyy-MMMMMMMMM-dd hh:mm:ss" /></tstamp>

    <uptodate property="theseus-jar-uptodate" targetfile="${SRC_LIB}/theseus.jar">
        <srcfiles dir="${SRC_CLASSES}/org" includes="**/*.java"/>
    </uptodate>

    <uptodate property="darkhorseventures-jar-uptodate" targetfile="${SRC_LIB}/darkhorseventures.jar">
        <srcfiles dir="${SRC_CLASSES}/com/darkhorseventures" includes="**/*.java"/>
    </uptodate>
    
    <uptodate property="isavvix-jar-uptodate" targetfile="${SRC_LIB}/isavvix.jar">
        <srcfiles dir="${SRC_CLASSES}/com/isavvix" includes="**/*.java"/>
    </uptodate>
    
    <uptodate property="apps-jar-uptodate" targetfile="${DEST_BIN}/Notifier.jar">
        <srcfiles dir="${SRC}">
          <include name="bin/com/darkhorseventures/**/*.java" />
          <include name="bin/notifier" />
          <include name="scripts/env.*" />
        </srcfiles>
    </uptodate>
    
    <!--uptodate property="zeroio-jar-uptodate" 
                targetfile="${SRC_LIB}/zeroio-iteam.jar">
        <srcfiles dir="${SRC_CLASSES}/com/zeroio" includes="**/*.java"/>
    </uptodate-->
    
    <!--uptodate property="ChartServlet-uptodate" 
                targetfile="${DEST_DOCROOT}/WEB-INF/classes/ChartServlet.class">
        <srcfiles dir="${SRC_APP}" includes="WEB-INF/classes/ChartServlet.class"/>
    </uptodate-->

    <uptodate property="site-uptodate" >
        <srcfiles dir="${SRC_APP}" >
          <include name="*" />
          <include name="images/**" />
          <include name="javascript/**" />
          <include name="WEB-INF/*.xml" />
          <include name="css/**" />
          <include name="WEB-INF/*.tld" />
          <exclude name="WEB-INF/web.xml" />
        </srcfiles>
        <mapper type="glob" from="*" to="${DEST_DOCROOT}/*"/>
     </uptodate>
  </target>

  <target name="" description="a target with a blank name." depends="init">
    <echo >
The date is ${TODAY}.
NOW is ${NOW}.
NOW2 is ${NOW2}.
NOW3 is ${NOW3}.
user home is ${user.home}
environment user is ${env.USER}
environment logname is ${env.LOGNAME}
determined user is ${USER}
    </echo>
    <echo message="Date: ${DSTAMP}"  />
    <echo message="System: ${os.name}"  />
    <echo message="Java version: ${ant.java.version}"  />
    <echo message="Source: ${SRC}" />
    <echo message="" />
    <echo message="Classpath: ${CLASSPATH}" />
  </target>

  <target name="theseus" description="compile theseus classes into JAR"
                depends="init" unless="theseus-jar-uptodate">
    <echo message=" Compiling Source: ${SRC_CLASSES}"/>
    <javac srcdir="${SRC_CLASSES}/org/theseus" verbose="off">
        <classpath>
            <path refid="cfs2.classpath"/>
        </classpath>
    </javac>
    <delete file="${SRC_LIB}/theseus.jar"/>
    <jar jarfile="${SRC_LIB}/theseus.jar"
          basedir="${SRC_CLASSES}"
          includes="org/theseus/**/*.class"/>
    <exec executable="chown" os="Linux" failonerror="true">
      <arg value="${USER}.${CFSGRP}"/>
      <arg value="${SRC_LIB}/theseus.jar"/>
    </exec>
    <delete>
        <fileset dir= "${SRC_CLASSES}/org/theseus" includes="**/*.class"/>
    </delete>
  </target>
  
  <target name="zeroio" description="compile zeroio classes into JAR"
          depends="init,theseus" unless="zeroio-jar-uptodate">
    <echo message=" Compiling Source: ${SRC_CLASSES}"/>
    <javac srcdir="${SRC_CLASSES}/com/darkhorseventures/webutils" verbose="off">
      <classpath>
        <path refid="cfs2.classpath"/>
        <pathelement location="${SRC_LIB}/theseus.jar"/>
      </classpath>
    </javac>
    <javac srcdir="${SRC_CLASSES}/com/zeroio" verbose="off">
      <classpath>
        <path refid="cfs2.classpath"/>
      </classpath>
    </javac>
    <delete file="${SRC_LIB}/zeroio-iteam.jar"/>
    <jar jarfile="${SRC_LIB}/zeroio-iteam.jar"
          basedir="${SRC_CLASSES}"
          includes="com/zeroio/**/*.class"/>
    <exec executable="chown" os="Linux" failonerror="true">
      <arg value="${USER}.${CFSGRP}"/>
      <arg value="${SRC_LIB}/zeroio-iteam.jar"/>
    </exec>
    <delete>
      <fileset dir= "${SRC_CLASSES}/com/zeroio" includes="**/*.class"/>
    </delete>
  </target>
  
  <target name="isavvix" description="compile isavvix into JAR" 
	  unless="isavvix-jar-uptodate">
    <echo message=" Compiling Source: ${SRC_CLASSES}"/>
    <javac srcdir="${SRC_CLASSES}/com/isavvix" verbose="off">
      <classpath>
        <path refid="cfs2.classpath"/>
      </classpath>
    </javac>
    <delete file="${SRC_LIB}/isavvix.jar"/>
    <jar jarfile="${SRC_LIB}/isavvix.jar"
          basedir="${SRC_CLASSES}"
          includes="com/isavvix/**/*.class"/>
    <exec executable="chown" os="Linux" failonerror="true">
      <arg value="${USER}.${CFSGRP}"/>
      <arg value="${SRC_LIB}/isavvix.jar"/>
    </exec>
    <delete>
      <fileset dir= "${SRC_CLASSES}/com/isavvix" includes="**/*.class"/>
    </delete>
  </target>

  <target name="darkhorseventures" description="compile dark horse classes into JAR"
          depends="init,theseus,isavvix" 
          unless="darkhorseventures-jar-uptodate">
    <echo message=" Compiling Source: ${SRC_CLASSES}"/>
    <javac srcdir="${SRC_CLASSES}/com/darkhorseventures" verbose="off">
      <classpath>
        <path refid="cfs2.classpath"/>
        <pathelement location="${SRC_LIB}/theseus.jar"/>
        <pathelement location="${SRC_LIB}/isavvix.jar"/>
        <pathelement location="${SRC_LIB}/zeroio-iteam.jar"/>
        <pathelement location="${SRC_LIB}/jfreechart.jar"/>
      </classpath>
    </javac>
    <delete file="${SRC_LIB}/darkhorseventures.jar"/>
    <jar jarfile="${SRC_LIB}/darkhorseventures.jar"
          basedir="${SRC_CLASSES}"
          includes="com/darkhorseventures/**/*.class"/>
    <exec executable="chown" os="Linux" failonerror="true">
      <arg value="${USER}.${CFSGRP}"/>
      <arg value="${SRC_LIB}/darkhorseventures.jar"/>
    </exec>
    <delete>
      <fileset dir= "${SRC_CLASSES}/com/darkhorseventures" includes="**/*.class"/>
    </delete>
  </target>

  <target name="site-home" description="only create the destination once in a while"
      depends="init">
      <!-- user should be running with root privileges
              else this will most likely fail -->
      <delete includeEmptyDirs="true" dir="${DEST}"/>
      <mkdir dir="${DEST}"/>
      <exec executable="chmod" os="Linux" failonerror="true">
        <arg value="2775"/>
        <arg value="${DEST}"/>
      </exec>
      <mkdir dir="${DEST_BIN}"/>
      <mkdir dir="${DEST_LOGS}"/>
      <mkdir dir="${DEST_DOCROOT}"/>
  </target>
  
  <target name="check-apps-configuration">
    <available file="${DEST_BIN}/notifier.xml" property="apps.config.present"/>
  </target>
  
  <target name="apps-configuration" depends="check-apps-configuration"
          unless="apps.config.present">
    <echo message="Installing App configuration files"/>
    <copy todir="${DEST_BIN}">
      <fileset dir="${SRC_BIN}">
        <include name="notifier.xml" />
      </fileset>
    </copy>
    <replace file="${DEST_BIN}/notifier.xml"
             token="@FILELIBRARY@" value="${DEST_DOCROOT}/WEB-INF/fileLibrary"/>
    <replace file="${DEST_BIN}/notifier.xml"
             token="@GKHOST@" value="${GKHOST}"/>
    <replace file="${DEST_BIN}/notifier.xml"
             token="@GKUSER@" value="${GKUSER}"/>
    <replace file="${DEST_BIN}/notifier.xml"
             token="@GKUSERPW@" value="${GKUSERPW}"/>
  </target>
  
  <target name="apps" description="Java applications that get installed."
      depends="init,darkhorseventures,apps-configuration"
      unless="apps-jar-uptodate">
    
    <echo message="Installing Apps"/>
    <echo message=" Site code: ${SITECODE}"/>
    <echo message=" Destination: ${DEST_BIN}"/>
    <echo message=" Source: ${SRC_BIN}"/>
    
    <javac srcdir="${SRC_BIN}/com/darkhorseventures" verbose="off">
      <classpath>
        <path refid="cfs2.classpath"/>
        <pathelement location="${SRC_BIN}"/>
        <pathelement location="${SRC_LIB}/theseus.jar"/>
        <pathelement location="${SRC_LIB}/darkhorseventures.jar"/>
        <pathelement location="${SRC_LIB}/zeroio-iteam.jar"/>
      </classpath>
    </javac>
    
    <jar jarfile="${DEST_BIN}/Notifier.jar" basedir="${SRC_BIN}"
          includes="com/darkhorseventures/apps/*.class"
          manifest="${SRC_BIN}/com/darkhorseventures/apps/notifier.mf"/>
    <copy todir="${DEST_BIN}" >
      <fileset dir="${SRC_BIN}">
        <include name="notifier" />
        <include name="html2ps" />
      </fileset>
    </copy>
    <chmod perm="a+x" >
      <fileset dir="${DEST_BIN}">
        <include name="notifier" />
        <include name="html2ps" />
      </fileset>
    </chmod>
    <copy todir="${DEST_BIN}\scripts" >
      <fileset dir="${SRC}\scripts">
        <include name="env.*" />
      </fileset>
    </copy>
  </target>
  
  <target name="check-site-configuration">
    <available file="${DEST_DOCROOT}/WEB-INF/web.xml" property="site.config.present"/>
  </target>
  
  <target name="site-configuration" depends="check-site-configuration"
          unless="site.config.present">
    <echo message="Installing web.xml configuration file"/>
    <copy todir="${DEST_DOCROOT}">
      <fileset dir="${SRC_APP}">
        <include name="WEB-INF/web.xml" />
      </fileset>
    </copy>
    <replace file="${DEST_DOCROOT}/WEB-INF/web.xml"
             token="@SiteCode@" value="${SITECODE}"/>

    <replace file="${DEST_DOCROOT}/WEB-INF/web.xml"
             token="@GKHOST@" value="${GKHOST}"/>

    <replace file="${DEST_DOCROOT}/WEB-INF/web.xml"
             token="@GKUSER@" value="${GKUSER}"/>

    <replace file="${DEST_DOCROOT}/WEB-INF/web.xml"
             token="@GKUSERPW@" value="${GKUSERPW}"/>
             
    <replace file="${DEST_DOCROOT}/WEB-INF/web.xml"
             token="@Keystore@" value="${DEST_DOCROOT}/WEB-INF/keystore"/>
  </target>

  <target name="site" description="Install files to site" 
          depends="init,site-configuration" unless="site-uptodate">
    <echo message="Installing site"/>
    <echo message=" Site code: ${SITECODE}"/>
    <echo message=" Destination: ${DEST}"/>
    <echo message=" Source: ${SRC_APP}"/>
    <copy todir="${DEST_BIN}" >
      <fileset dir="${SRC_BIN}">
        <include name="*" />
        <exclude name="notifier.xml" />
      </fileset>
    </copy>
    <delete dir="${DEST_BIN}/com"/>
    <chmod perm="+x" >
      <fileset dir="${DEST_BIN}">
        <include name="*" />
      </fileset>
    </chmod>

    <copy todir="${DEST_DOCROOT}" >
      <fileset dir="${SRC_APP}">
        <include name="*" />
        <include name="images/**" />
        <include name="javascript/**" />
        <include name="WEB-INF/*.xml" />
        <include name="css/**" />
        <include name="WEB-INF/*.tld" />
        <exclude name="WEB-INF/web.xml" />
      </fileset>
    </copy>

    <mkdir dir="${DEST_DOCROOT}/graphs"/>
    <!--delete dir="${DEST_DOCROOT}/bin"/-->
    
    <exec executable="chown" os="Linux" >
      <arg value="-R"/>
      <arg value="${WEBUSER}.${CFSGRP}"/>
      <arg value="${DEST}"/>
    </exec>

    <exec executable="chmod" os="Linux" failonerror="true">
      <arg value="-R"/>
      <arg value="g+w"/>
      <arg value="${DEST}"/>
    </exec>

  </target>

  <target name="ChartServlet" description="Install special class."
          depends="init,site" unless="ChartServlet-uptodate">
    <echo message="Installing ChartServlet"/>
    <echo message=" Site code: ${SITECODE}"/>
    <echo message=" Destination: ${DEST}"/>
    <echo message=" Source: ${SRC_APP}"/>

    <!-- ChartServlet.class needs to be integrated into JAR  -->
    <copy todir="${DEST_DOCROOT}" >
      <fileset dir="${SRC_APP}">
        <include name="WEB-INF/classes/ChartServlet.class" />
      </fileset>
    </copy>
  </target>

  <target name="lib" description="Install library files to site." 
        depends="init,site,darkhorseventures,theseus,apps">
    <echo message="Installing JAR files"/>
    <echo message=" Site code: ${SITECODE}"/>
    <echo message=" Destination: ${DEST_DOCROOT}"/>
    <echo message=" Source: ${SRC_APP}/WEB-INF/lib/*.jar"/>
  
    <copy todir="${DEST_DOCROOT}" >
      <fileset dir="${SRC_APP}">
        <include name="WEB-INF/lib/*.jar" />
      </fileset>
    </copy>
  </target>

  <target name="docs" description="Install Documentation files to site." 
        depends="init,site,darkhorseventures,theseus,apps">
    <echo message="Installing Class Documentation files"/>
    <echo message=" Site: ${SITECODE}"/>
    <echo message=" Destination: ${DEST_DOCROOT}"/>
    <echo message=" Source: ${SRC_APP}"/>
    <mkdir dir="${DEST_DOCROOT}/docs"/>
    <echo message=" javadocs Source: ${SRC_CLASSES}"/>
    <javadoc sourcepath="${SRC_CLASSES}"
          packagenames="com.*,org.*"
          destdir="${DEST_DOCROOT}/docs"
          excludepackagenames="javax.servlet">
      <header>Copyright 2001-2002 Dark Horse Ventures</header>
      <footer>Copyright 2001-2002 Dark Horse Ventures</footer>
      <classpath>
        <path refid="cfs2.classpath"/>
        <pathelement location="${SRC_LIB}/theseus.jar"/>
      </classpath>
    </javadoc>
  </target>
  
  <target name="builddb" description="Creates a new database">
    <echo message="Building database"/>
    
    <!-- Prepare files for any database type -->
    <delete dir="${SRC}/tmp" failonerror="false"/>
    <mkdir dir="${SRC}/tmp"/>
    <copy todir="${SRC}/tmp">
      <fileset dir="${SRC}/database">
        <include name="*.init" />
      </fileset>
    </copy>
    
    <!-- Only needed for MSSQL -->
    <replace dir="${SRC}/tmp" token="true" value="1">
      <include name="*.init"/>
    </replace>
    <replace dir="${SRC}/tmp" token="false" value="0">
      <include name="*.init"/>
    </replace>
  
    <!-- Create database and initialize data -->
    <sql
        driver="com.microsoft.jdbc.sqlserver.SQLServerDriver"
        url="jdbc:microsoft:sqlserver://127.0.0.1:1433;DatabaseName=cdb_cfs;SelectMethod=cursor"
        userid="dhv_appuser"
        password="@pus3r">
        <!--driver="org.postgresql.Driver"-->
      <classpath>
        <path refid="cfs2.classpath"/>
      </classpath>
        
      <transaction src="database/${DBTYPE}/gatekeeper.sql"/>
      <transaction src="database/gatekeeper.init"/>
      
      <transaction src="database/${DBTYPE}/new_cdb.sql"/>
      <transaction src="database/code_tables.init"/>
      <transaction src="database/access.init"/>
      <transaction src="database/organization.init"/>
      <transaction src="${SRC}/tmp/permissions.init"/>
      <transaction src="${SRC}/tmp/data.init"/>
      
      <transaction src="database/${DBTYPE}/new_cfs2.sql"/>
      
      <transaction src="database/${DBTYPE}/new_opportunity.sql"/>
      <transaction src="${SRC}/tmp/opportunity.init"/>
      
      <transaction src="database/${DBTYPE}/new_tms.sql"/>
      <transaction src="${SRC}/tmp/tms.init"/>
      
      <transaction src="database/${DBTYPE}/new_custom_field.sql"/>
      
      <transaction src="database/${DBTYPE}/new_project.sql"/>
      <transaction src="${SRC}/tmp/project.init"/>
      
      <transaction src="database/${DBTYPE}/new_campaign.sql"/>
      <transaction src="${SRC}/tmp/campaign.init"/>
      
      <transaction src="database/${DBTYPE}/new_help.sql"/>
      
      <transaction src="database/${DBTYPE}/new_sync.sql"/>
      <transaction src="${SRC}/tmp/sync.init"/>
      
      <transaction src="database/${DBTYPE}/new_autoguide.sql"/>
      <transaction src="${SRC}/tmp/autoguide.init"/>
    </sql>
    <delete dir="${SRC}/tmp" failonerror="false"/>
  </target>
</project>
